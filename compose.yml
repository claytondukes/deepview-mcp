services:
  deepview-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${CONTAINER_NAME:-deepview-mcp}
    ports:
      - "${MCP_HOST:-127.0.0.1}:${MCP_PORT:-8019}:${MCP_PORT:-8019}"
    volumes:
      # Mount codebase directory
      - ${CODEBASE_PATH:-./codebase}:/app/codebase:ro
      # Mount logs directory
      - ${LOGS_PATH:-./logs}:/app/logs:rw
      # Mount data directory for persistent storage
      - ${DATA_PATH:-./data}:/data:rw
    environment:
      # Gemini API Configuration
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.5-flash}
      # MCP Server Configuration
      - MCP_TRANSPORT=${MCP_TRANSPORT:-http}
      - MCP_HOST=${MCP_HOST:-0.0.0.0}
      - MCP_PORT=${MCP_PORT:-8019}
      - MCP_SERVER_NAME=deepview-mcp
      - MCP_DESCRIPTION=DeepView MCP - Codebase Analysis Server
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      # OAuth / OIDC Configuration
      - OAUTH_ENABLED=${OAUTH_ENABLED:-false}
      - OIDC_ISSUER=${OIDC_ISSUER:-}
      - OIDC_AUDIENCE=${OIDC_AUDIENCE:-}
      - OIDC_JWKS_URL=${OIDC_JWKS_URL:-}
      - OIDC_ALGS=${OIDC_ALGS:-RS256}
      - OAUTH_REQUIRED_SCOPES=${OAUTH_REQUIRED_SCOPES:-deepview:read}
      - OAUTH_CLOCK_SKEW_SECONDS=${OAUTH_CLOCK_SKEW_SECONDS:-60}
    command: >
      python -m deepview_mcp.cli
      --transport ${MCP_TRANSPORT:-http} 
      --host ${MCP_HOST:-0.0.0.0} 
      --port ${MCP_PORT:-8019}
      --log-level ${LOG_LEVEL:-INFO} 
      --model ${GEMINI_MODEL:-gemini-2.5-flash}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MCP_PORT:-8019}/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-60s}

  nginx-shim:
    image: nginx:1.27-alpine
    container_name: ${NGINX_SHIM_CONTAINER_NAME:-deepview-mcp-nginx-shim}
    depends_on:
      - deepview-mcp
    ports:
      - "${SHIM_HOST:-127.0.0.1}:${SHIM_PORT:-8080}:8080"
    volumes:
      - ./nginx/mcp-oauth-shim.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

networks:
  default:
    name: ${NETWORK_NAME:-deepview-mcp-network}
